# Milestone 4 å®Œæˆæ€»ç»“ï¼šæ™ºèƒ½åˆ†å±‚ä¸Šä¸‹æ–‡æ³¨å…¥

## æ¦‚è¿°

Milestone 4 æˆåŠŸå®ç°äº† ContextAgent çš„æ ¸å¿ƒæ™ºèƒ½åŠŸèƒ½â€”â€”**æ™ºèƒ½åˆ†å±‚ä¸Šä¸‹æ–‡æ³¨å…¥ç³»ç»Ÿ**ï¼Œè¿™æ˜¯ ContextAgent ä»åŸºç¡€åˆ†æå·¥å…·è½¬å˜ä¸ºçœŸæ­£æ™ºèƒ½ä»£ç åŠ©æ‰‹çš„å…³é”®é‡Œç¨‹ç¢‘ã€‚

## ğŸ¯ å®ç°çš„æ ¸å¿ƒåŠŸèƒ½

### 1. å¢å¼ºçš„é™æ€åˆ†æå™¨

#### æ–°å¢å…³ç³»ç±»å‹
- **ReferenceRelation**: è¿½è¸ªå˜é‡å’Œå±æ€§å¼•ç”¨
- **ImplementsRelation**: è¿½è¸ªç±»çš„ç»§æ‰¿å’Œæ¥å£å®ç°å…³ç³»  
- **InstantiatesRelation**: è¿½è¸ªæ„é€ å‡½æ•°è°ƒç”¨å’Œå¯¹è±¡å®ä¾‹åŒ–

#### å¢å¼ºçš„åˆ†æèƒ½åŠ›
- **CallRelation å¢å¼º**: åŒºåˆ†ç›´æ¥è°ƒç”¨ã€æ–¹æ³•è°ƒç”¨å’Œæ„é€ å‡½æ•°è°ƒç”¨
- **NewExpression åˆ†æ**: ä¸“é—¨å¤„ç† `new` è¡¨è¾¾å¼
- **Identifier å¼•ç”¨è¿½è¸ª**: æ™ºèƒ½è¯†åˆ«å˜é‡å’Œå‡½æ•°å¼•ç”¨
- **PropertyAccess åˆ†æ**: è¿½è¸ªå±æ€§è®¿é—®æ¨¡å¼

### 2. åˆ†å±‚ä¸Šä¸‹æ–‡æ¨¡å‹ (L0-L3)

#### L0: æ ¸å¿ƒä¸Šä¸‹æ–‡ (æœ€é«˜ä¼˜å…ˆçº§)
- ç›´æ¥ä»ç”¨æˆ·è¾“å…¥ä¸­æå–çš„æ ¸å¿ƒå®ä½“
- åŒ…å«ä¸æŸ¥è¯¢ç›´æ¥ç›¸å…³çš„ä»£ç å…ƒç´ 
- æä¾›æœ€ç²¾å‡†çš„ä¸Šä¸‹æ–‡ä¿¡æ¯

#### L1: å³æ—¶ä¸Šä¸‹æ–‡ (é«˜ä¼˜å…ˆçº§)  
- æ ¸å¿ƒå®ä½“çš„ä¸€è·³é‚»å±…
- ç›´æ¥ç›¸å…³çš„å‡½æ•°ã€ç±»å’Œæ–‡ä»¶
- æ‰©å±•æŸ¥è¯¢çš„ç›´æ¥å½±å“èŒƒå›´

#### L2: æ‰©å±•ä¸Šä¸‹æ–‡ (ä¸­ç­‰ä¼˜å…ˆçº§)
- äºŒè·³é‚»å±…å’Œæ›´å¹¿æ³›çš„ä»£ç æ¨¡å¼
- æä¾›æ›´å®½æ³›çš„é¡¹ç›®ç†è§£
- å¸®åŠ©è¯†åˆ«é—´æ¥ç›¸å…³æ€§

#### L3: å…¨å±€ä¸Šä¸‹æ–‡ (æœ€ä½ä¼˜å…ˆçº§)
- é¡¹ç›®æ•´ä½“ç»Ÿè®¡å’Œæ¦‚è§ˆä¿¡æ¯
- æ¶æ„çº§åˆ«çš„ç†è§£
- ä½œä¸ºå…œåº•çš„èƒŒæ™¯ä¿¡æ¯

### 3. Token é¢„ç®—ç®¡ç†å™¨

#### æ™ºèƒ½é¢„ç®—æ§åˆ¶
- åŠ¨æ€ Token é¢„ç®—åˆ†é… (é»˜è®¤ 8000 tokens)
- åŸºäºä¼˜å…ˆçº§çš„è´ªå¿ƒå¡«å……ç®—æ³•
- æ™ºèƒ½æˆªæ–­æœºåˆ¶ï¼Œç¡®ä¿ä¸è¶…å‡ºæ¨¡å‹é™åˆ¶

#### ä¼°ç®—ç®—æ³•
- å®ä½“å†…å®¹ä¼°ç®—: ~20 tokens/å®ä½“
- å…³ç³»ä¿¡æ¯ä¼°ç®—: ~15 tokens/å…³ç³»  
- æ ¼å¼å¼€é”€ä¼°ç®—: ~50 tokens/å±‚
- æ–‡æœ¬å†…å®¹ä¼°ç®—: ~4 å­—ç¬¦/token

### 4. é‡æ„çš„ä¸Šä¸‹æ–‡æ³¨å…¥ç³»ç»Ÿ

#### æ–°çš„ getContextForPrompt æ–¹æ³•
- å®Œå…¨æ›¿æ¢äº† Milestone 3 çš„å®ç°
- ä½¿ç”¨åˆ†å±‚ä¸Šä¸‹æ–‡ç®¡ç†å™¨è¿›è¡Œæ™ºèƒ½åˆ†æ
- æä¾›è¯¦ç»†çš„è°ƒè¯•å’Œæ€§èƒ½ä¿¡æ¯
- åŒ…å«é™çº§æœºåˆ¶ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šæ€§

#### å®ä½“æå–ç®—æ³•
- æ–‡ä»¶æ¨¡å¼è¯†åˆ«: `*.ts`, `*.js`, `*.py` ç­‰
- å‡½æ•°/ç±»æ¨¡å¼åŒ¹é…: `function X`, `class Y`
- å¼•ç”¨å†…å®¹æå–: å¼•å·åŒ…å›´çš„æ ‡è¯†ç¬¦
- æ ‡è¯†ç¬¦æ¨¡å¼: CamelCase/PascalCase è¯†åˆ«

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### æ ¸å¿ƒæ–‡ä»¶ç»“æ„

```
packages/core/src/context/
â”œâ”€â”€ layeredContextManager.ts    # æ–°å¢ï¼šåˆ†å±‚ä¸Šä¸‹æ–‡ç®¡ç†å™¨
â”œâ”€â”€ staticAnalyzer.ts          # å¢å¼ºï¼šæ–°å¢å…³ç³»ç±»å‹å’Œåˆ†æèƒ½åŠ›
â”œâ”€â”€ knowledgeGraph.ts          # å¢å¼ºï¼šæ–°å¢æŸ¥è¯¢æ–¹æ³•
â””â”€â”€ contextAgent.ts            # é‡æ„ï¼šgetContextForPrompt æ–¹æ³•
```

### å…³é”®ç®—æ³•å®ç°

#### 1. åˆ†å±‚ä¸Šä¸‹æ–‡ç”Ÿæˆç®—æ³•
```typescript
async generateLayeredContext(userInput: string, maxTokens: number) {
  // 1. ç”Ÿæˆ L0 æ ¸å¿ƒä¸Šä¸‹æ–‡
  const l0Context = await this.generateL0Context(userInput, budget);
  
  // 2. åŸºäº L0 ç”Ÿæˆ L1 å³æ—¶ä¸Šä¸‹æ–‡  
  const l1Context = await this.generateL1Context(userInput, l0Entities, budget);
  
  // 3. åŸºäº L0+L1 ç”Ÿæˆ L2 æ‰©å±•ä¸Šä¸‹æ–‡
  const l2Context = await this.generateL2Context(userInput, allEntities, budget);
  
  // 4. ç”Ÿæˆ L3 å…¨å±€ä¸Šä¸‹æ–‡
  const l3Context = await this.generateL3Context(budget);
  
  return { layers, totalTokens, truncated };
}
```

#### 2. å®ä½“æå–ç®—æ³•
```typescript
extractCoreEntitiesFromInput(userInput: string): string[] {
  // æ–‡ä»¶æ¨¡å¼åŒ¹é…
  const filePatterns = input.match(/[\w-]+\.(ts|js|jsx|tsx|py|java)/gi);
  
  // å‡½æ•°/ç±»æ¨¡å¼åŒ¹é…
  const functionPatterns = input.match(/\b(?:function|class|method|api)\s+(\w+)/gi);
  
  // å¼•ç”¨å†…å®¹æå–
  const quotedPatterns = input.match(/['"`]([^'"`]+)['"`]/g);
  
  // æ ‡è¯†ç¬¦æ¨¡å¼åŒ¹é…
  const identifierPatterns = input.match(/\b[A-Z][a-zA-Z0-9]*\b/g);
}
```

#### 3. Token é¢„ç®—ç®¡ç†ç®—æ³•
```typescript
private fitsInBudget(context: ContextLayer, budget: TokenBudget): boolean {
  return context.estimatedTokens <= budget.remainingTokens;
}

private consumeBudget(tokens: number, budget: TokenBudget): void {
  budget.usedTokens += tokens;
  budget.remainingTokens = budget.maxTokens - budget.usedTokens;
}
```

## ğŸ“Š æ€§èƒ½ç‰¹æ€§

### ä¼˜åŒ–ç­–ç•¥
- **é‚»å±…é™åˆ¶**: ä¸€è·³é‚»å±…é™åˆ¶ 20 ä¸ªï¼ŒäºŒè·³é‚»å±…é™åˆ¶ 15 ä¸ª
- **å…³ç³»è¿‡æ»¤**: æ™ºèƒ½è¿‡æ»¤å£°æ˜ã€è°ƒç”¨ç­‰å™ªéŸ³èŠ‚ç‚¹
- **å†…å­˜ç®¡ç†**: ä½¿ç”¨ Set é¿å…é‡å¤å®ä½“å¤„ç†
- **é”™è¯¯æ¢å¤**: å¤šå±‚æ¬¡é™çº§æœºåˆ¶ç¡®ä¿ç³»ç»Ÿå¯ç”¨æ€§

### è°ƒè¯•èƒ½åŠ›
- è¯¦ç»†çš„ Token ä½¿ç”¨ç»Ÿè®¡
- åˆ†å±‚ä¸Šä¸‹æ–‡ç”Ÿæˆè¿‡ç¨‹è·Ÿè¸ª
- æˆªæ–­åŸå› å’Œè¯¦æƒ…è®°å½•
- å®ä½“æå–å’ŒåŒ¹é…è¿‡ç¨‹æ—¥å¿—

## ğŸ”„ é›†æˆå’Œå…¼å®¹æ€§

### å‘åå…¼å®¹
- ä¿æŒ Milestone 2 å’Œ 3 çš„æ‰€æœ‰å…¬å…±æ¥å£
- æä¾›é™çº§æœºåˆ¶ï¼Œç¡®ä¿åœ¨åˆ†å±‚ä¸Šä¸‹æ–‡å¤±è´¥æ—¶ä»å¯å·¥ä½œ
- ç»´æŠ¤ç°æœ‰çš„è°ƒè¯•å’Œç›‘æ§åŠŸèƒ½

### ä¸ç°æœ‰ç³»ç»Ÿé›†æˆ
- æ— ç¼é›†æˆåˆ°ç°æœ‰çš„ Config å’Œ ContextManager ä¸­
- ç»§ç»­æ”¯æŒç°æœ‰çš„ `/init` å‘½ä»¤å’Œé¡¹ç›®æ‰«æåŠŸèƒ½
- ä¿æŒä¸ OpenAI hijack ç³»ç»Ÿçš„å…¼å®¹æ€§

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### ç”¨æˆ·æŸ¥è¯¢ç¤ºä¾‹
```
ç”¨æˆ·: "ä¼˜åŒ– UserService ä¸­çš„ getUserById æ–¹æ³•"
```

### L0 æ ¸å¿ƒä¸Šä¸‹æ–‡
```
ğŸ¯ L0: Core Context (Query-Specific)
Entities directly relevant to your query:
- UserService
- getUserById
- function:src/services/UserService.ts:getUserById
```

### L1 å³æ—¶ä¸Šä¸‹æ–‡  
```
ğŸ”— L1: Immediate Context (One-Hop)
Related entities (8 found):
- User (class)
- UserRepository (class)  
- validateUserId (function)
- handleUserNotFound (function)
```

### Token ä½¿ç”¨ç»Ÿè®¡
```
Context generated using 2,340 tokens across 4 layers
L0: 340 tokens, L1: 680 tokens, L2: 920 tokens, L3: 400 tokens
```

## âœ… éªŒè¯å’Œæµ‹è¯•

### ç¼–è¯‘éªŒè¯
- âœ… TypeScript ç¼–è¯‘æ— é”™è¯¯
- âœ… æ„å»ºè¿‡ç¨‹æˆåŠŸå®Œæˆ
- âœ… æ‰€æœ‰ç±»å‹å®šä¹‰æ­£ç¡®

### åŠŸèƒ½éªŒè¯
- âœ… åˆ†å±‚ä¸Šä¸‹æ–‡ç”Ÿæˆç®—æ³•æ­£å¸¸å·¥ä½œ
- âœ… Token é¢„ç®—ç®¡ç†å™¨æ­£ç¡®æ§åˆ¶è¾“å‡ºå¤§å°
- âœ… å®ä½“æå–ç®—æ³•è¯†åˆ«å„ç§æ¨¡å¼
- âœ… é™çº§æœºåˆ¶åœ¨é”™è¯¯æƒ…å†µä¸‹æ­£å¸¸å·¥ä½œ

## ğŸ“ˆ æœªæ¥å‘å±•æ–¹å‘

Milestone 4 ä¸ºåç»­å‘å±•å¥ å®šäº†åšå®åŸºç¡€ï¼š

### Milestone 5: å®æ—¶å¢é‡æ›´æ–°
- åŸºäºåˆ†å±‚ä¸Šä¸‹æ–‡çš„å¢é‡æ›´æ–°ç­–ç•¥
- æ™ºèƒ½ç¼“å­˜å’Œå¤±æ•ˆæœºåˆ¶

### Milestone 6: ç¨³å¥æ€§ä¼˜åŒ–
- æ€§èƒ½è°ƒä¼˜å’Œå¤§è§„æ¨¡é¡¹ç›®æ”¯æŒ
- ç”¨æˆ·ä½“éªŒä¼˜åŒ–å’Œé”™è¯¯å¤„ç†å¢å¼º

### é«˜çº§åŠŸèƒ½æ‰©å±•
- è¯­ä¹‰æœç´¢é›†æˆ (å‘é‡åµŒå…¥)
- å¤šè¯­è¨€æ”¯æŒæ‰©å±•
- Git å†å²é›†æˆ

## ğŸ‰ é‡Œç¨‹ç¢‘æˆå°±

Milestone 4 çš„å®Œæˆæ ‡å¿—ç€ ContextAgent ä»ç®€å•çš„é™æ€åˆ†æå·¥å…·**æ¼”è¿›ä¸ºå…·å¤‡çœŸæ­£æ™ºèƒ½çš„ä»£ç ç†è§£ç³»ç»Ÿ**ï¼š

1. **æ™ºèƒ½åŒ–**: ä»é™æ€è§„åˆ™åˆ°åŠ¨æ€æ™ºèƒ½åˆ†æ
2. **æ•ˆç‡åŒ–**: ä»å…¨é‡ä¸Šä¸‹æ–‡åˆ°ç²¾å‡†åˆ†å±‚ä¸Šä¸‹æ–‡
3. **å¯æ§åŒ–**: ä»æ— é™åˆ¶åˆ°æ™ºèƒ½é¢„ç®—ç®¡ç†
4. **å¯æ‰©å±•åŒ–**: ä»å›ºå®šæ¨¡å¼åˆ°å¯æ‰©å±•æ¶æ„

è¿™ä¸º Gemini CLI æä¾›äº†å¼ºå¤§çš„é¡¹ç›®æ„ŸçŸ¥èƒ½åŠ›ï¼Œä½¿å…¶èƒ½å¤Ÿ**çœŸæ­£ç†è§£ä»£ç ç»“æ„å’Œå…³ç³»ï¼Œæä¾›ç²¾å‡†ä¸”ç›¸å…³çš„ç¼–ç¨‹ååŠ©**ã€‚