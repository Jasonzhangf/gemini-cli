# 激发存储功能 (Memory Storage Feature)

## 概览

激发存储功能允许用户将重要的信息、经验和知识保存为记忆，分为全局记忆和项目记忆两种类型。这些记忆会自动集成到上下文系统中，为AI助手提供持久的知识基础。

## 核心概念

### 记忆类型

1. **全局记忆 (Global Memory)**
   - 适用于所有项目的通用知识和经验
   - 存储位置：`~/.gemini/memories/Memory.md`
   - 使用场景：编程最佳实践、通用问题解决方案、个人偏好等

2. **项目记忆 (Project Memory)**
   - 当前项目特定的知识和经验
   - 存储位置：`./gemini/memories/Memory.md`
   - 使用场景：项目特定的设计决策、架构说明、技术细节等

### 存储结构

记忆以Markdown格式存储在Memory.md文件中，结构如下：

```
# 全局记忆存储 / 项目记忆存储

*适用于所有项目的通用知识和经验 / 当前项目的特定知识和经验*

> 此文件由激发存储功能自动维护，记录了重要的知识和经验。
> 最新的记忆条目显示在前面。

## 记忆标题

**类型**: 全局记忆 / 项目记忆  
**时间**: 2025-01-13 15:30:00  
**ID**: `memory_1705234567890_abc123`  
**标签**: `编程`, `最佳实践`  

### 内容

[记忆的具体内容...]

---

## 另一个记忆标题

...
```

## 工具接口

### save_memory 工具

保存新的记忆条目。

**参数**:
- `content` (必需): 要保存的记忆内容
- `type` (必需): 记忆类型，`"project"` 或 `"global"`
- `title` (可选): 记忆标题
- `tags` (可选): 标签数组

**示例**:
```json
{
  "content": "使用TypeScript时，优先使用接口而非类型别名来定义对象结构，这样可以获得更好的扩展性和调试体验。",
  "type": "global",
  "title": "TypeScript最佳实践",
  "tags": ["typescript", "最佳实践", "接口"]
}
```

### view_memories 工具

查看和管理现有记忆。

**参数**:
- `type` (可选): 要查看的记忆类型，`"project"`、`"global"` 或 `"both"`，默认为 `"both"`
- `action` (可选): 执行的操作，`"view"`、`"stats"` 或 `"cleanup"`，默认为 `"stats"`
- `cleanup_keep_count` (可选): 清理时保留的记忆数量，默认为50

**示例**:
```json
{
  "type": "both",
  "action": "stats"
}
```

## 上下文集成

### 自动加载

记忆会在系统初始化时自动加载到静态上下文中：

- 全局记忆：每次启动时都会加载，适用于所有项目
- 项目记忆：仅在对应项目中加载

### 上下文结构

在标准化上下文中，记忆作为静态上下文的一部分：

```typescript
interface StaticContext {
  globalRules?: string[];
  projectRules?: string[];
  globalMemories?: string[];    // 全局记忆
  projectMemories?: string[];   // 项目记忆
  // ... 其他字段
}
```

### 格式化输出

在生成的上下文中，记忆会以清晰的格式显示：

```markdown
# 📋 静态上下文 (Static Context)

## 🧠 全局记忆 (1个)
*适用于所有项目的知识和经验*

--- 全局记忆: Memory.md ---
[记忆内容...]

## 💡 项目记忆 (1个)
*当前项目特定的知识和经验*

--- 项目记忆: Memory.md ---
[记忆内容...]
```

## 使用场景

### 1. 保存编程最佳实践

```bash
# 保存为全局记忆
save_memory with content "在React项目中，总是使用函数组件和Hooks，避免使用类组件。使用memo()优化性能，使用useCallback和useMemo避免不必要的重渲染。" type "global" title "React最佳实践" tags ["react", "性能优化", "最佳实践"]
```

### 2. 记录项目特定的设计决策

```bash
# 保存为项目记忆
save_memory with content "在这个项目中，我们选择使用PostgreSQL而不是MySQL，主要原因是需要JSON支持和更好的全文搜索功能。数据库配置文件位于config/database.ts。" type "project" title "数据库选择决策" tags ["数据库", "postgresql", "架构决策"]
```

### 3. 记录问题解决方案

```bash
# 保存全局记忆
save_memory with content "解决Node.js内存泄漏的步骤：1. 使用--inspect启动应用 2. 使用Chrome DevTools的Memory选项卡 3. 对比多次堆快照找出增长的对象 4. 检查事件监听器和定时器是否正确清理" type "global" title "Node.js内存泄漏调试"
```

### 4. 查看和管理记忆

```bash
# 查看统计信息
view_memories

# 查看所有记忆内容
view_memories with action "view"

# 清理旧记忆，保留最新的30条
view_memories with action "cleanup" cleanup_keep_count 30
```

## 技术实现

### 核心组件

1. **MemoryStorageService**: 核心存储服务
   - 处理Memory.md文件的读写
   - 管理记忆条目的格式化
   - 提供清理和统计功能

2. **SaveMemoryTool**: 保存记忆工具
   - 用户接口，接收记忆内容和元数据
   - 调用存储服务保存记忆

3. **ViewMemoriesTool**: 查看记忆工具
   - 提供查看、统计和清理功能
   - 支持截断长内容避免输出过长

4. **ContextManager集成**: 
   - 自动加载记忆到静态上下文
   - 支持双层结构（全局+项目）

### 数据流

1. **保存流程**:
   ```
   用户输入 → SaveMemoryTool → MemoryStorageService → Memory.md文件
   ```

2. **加载流程**:
   ```
   系统启动 → ContextManager.initialize() → loadGlobalMemories() + loadProjectMemories() → 静态上下文
   ```

3. **使用流程**:
   ```
   用户查询 → StandardContextIntegrator → 包含记忆的完整上下文 → AI模型
   ```

## 性能考虑

1. **内存优化**: 记忆内容在格式化输出时会被适当截断
2. **磁盘I/O**: 记忆仅在系统初始化时加载一次
3. **清理机制**: 提供自动清理功能，避免记忆文件过大
4. **缓存策略**: 记忆加载后缓存在内存中，避免重复读取

## 最佳实践

### 编写记忆内容

1. **简洁明了**: 记忆内容应该简洁、准确、易于理解
2. **包含上下文**: 提供足够的背景信息，让AI能够正确应用
3. **使用标签**: 合理使用标签有助于分类和检索
4. **定期维护**: 使用清理功能移除过时的记忆

### 选择记忆类型

1. **全局记忆**: 通用知识、个人偏好、跨项目的经验
2. **项目记忆**: 项目特定的决策、配置、架构说明

### 记忆管理

1. **定期清理**: 每月或每季度清理一次旧记忆
2. **合理数量**: 建议每种类型的记忆不超过50条
3. **质量优于数量**: 保留高质量、经常使用的记忆

## 扩展功能

### 未来改进方向

1. **智能检索**: 基于语义相似度的记忆检索
2. **自动分类**: AI自动为记忆添加标签和分类
3. **记忆推荐**: 根据当前上下文推荐相关记忆
4. **版本控制**: 记忆的版本管理和变更历史
5. **团队共享**: 支持团队级别的记忆共享和同步

### 集成扩展

1. **IDE插件**: 在开发环境中直接保存和查看记忆
2. **Web界面**: 提供图形化的记忆管理界面
3. **API接口**: 开放API供第三方工具集成
4. **导入导出**: 支持记忆的批量导入导出

## 故障排除

### 常见问题

1. **记忆未加载**: 检查文件路径和权限
2. **内容格式错误**: 确认Memory.md文件格式正确
3. **性能问题**: 使用清理功能减少记忆数量

### 调试方法

1. **启用调试模式**: 在Config中设置debugMode为true
2. **检查日志**: 查看ContextManager的初始化日志
3. **手动验证**: 直接查看Memory.md文件内容

## 总结

激发存储功能为Gemini CLI提供了强大的知识管理能力，通过全局记忆和项目记忆的双层结构，用户可以积累和复用宝贵的经验和知识。该功能与现有的上下文系统无缝集成，为AI助手提供了更丰富的背景信息，从而提高工作效率和决策质量。